<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Stylista</title>
<style>
body { margin:0; font-family:sans-serif; background:#222; color:#fff; display:flex; flex-direction:column; align-items:center; }
h1 { margin:20px 0; }
#userPanel { width:90%; padding:10px; background:#333; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
#songList { width:90%; display:flex; flex-direction:column; gap:15px; }
.songItem { padding:15px; background:#444; border-radius:10px; text-align:center; cursor:pointer; user-select:none; transition:0.2s; }
.songItem:hover { background:#666; }
canvas { display:block; }
#scoreBoard { position:absolute; top:10px; right:10px; color:#fff; font-size:20px; }
#tutorial { width:90%; padding:10px; background:#444; border-radius:10px; margin-bottom:10px; }
</style>
</head>
<body>
<h1>Stylista</h1>

<!-- ユーザページ -->
<div id="userPanel">
  <div>
    ユーザ名: <input type="text" id="username" placeholder="Enter name">
  </div>
  <div>
    称号: <span id="titles">なし</span>
  </div>
</div>

<!-- チュートリアル表示 -->
<div id="tutorial">
  チュートリアル: 基本操作を確認してください
</div>

<!-- 選曲画面 -->
<div id="songList"></div>

<!-- プレイ画面 -->
<canvas id="gameCanvas" style="display:none;"></canvas>
<div id="scoreBoard"></div>

<script>
// ==== ユーザデータ保存 ====
const usernameInput = document.getElementById('username');
const titlesSpan = document.getElementById('titles');
function loadUserData() {
  const name = localStorage.getItem('stylista_name') || '';
  const titles = JSON.parse(localStorage.getItem('stylista_titles')||'[]');
  usernameInput.value = name;
  titlesSpan.textContent = titles.length? titles.join(', '): 'なし';
}
function saveUserData() {
  localStorage.setItem('stylista_name', usernameInput.value);
}
usernameInput.addEventListener('change', saveUserData);
loadUserData();

// ==== 選曲リスト ====
const songs = [
  { title:'チュートリアル', file:'tutorial.sla' },
  { title:'曲サンプル1', file:'song1.sla' }
];
const container = document.getElementById('songList');
songs.forEach(song=>{
  const div = document.createElement('div');
  div.className='songItem';
  div.textContent=song.title;
  div.addEventListener('click',()=>loadSong(song.file));
  container.appendChild(div);
});

// ==== プレイ画面 ====
async function loadSong(file){
  let sla;
  if(file==='tutorial.sla'){
    sla={
      meta:{title:'チュートリアル', totalNotes:5},
      notes:[
        {beat:0, lane:0, type:'single'},
        {beat:1, lane:1, type:'single'},
        {beat:2, lane:2, type:'all'},
        {beat:3, lane:3, type:'single'},
        {beat:4, lane:0, type:'long', endBeat:5}
      ]
    };
  }else{
    const res = await fetch(file);
    sla = await res.json();
  }
  startPlay(sla);
}

function startPlay(sla){
  document.getElementById('songList').style.display='none';
  const canvas = document.getElementById('gameCanvas');
  const scoreBoard = document.getElementById('scoreBoard');
  canvas.style.display='block';
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');

  const lanes=4;
  const laneWidth=canvas.width/lanes;
  const noteWidth = laneWidth/3;

  let score=0, combo=0, notesHit=0;
  let pressedLanes=[];

  // 判定幅(ms)
  const judgment = [
    {name:'StylistaPerfect', ms:30},
    {name:'Perfect', ms:40},
    {name:'Great', ms:60},
    {name:'Good', ms:80},
    {name:'Over', ms:Infinity}
  ];

  // キー・タッチ判定
  window.addEventListener('keydown', e=>{
    const keyMap={'D':0,'F':1,'J':2,'K':3};
    if(keyMap[e.key.toUpperCase()]!==undefined && !pressedLanes.includes(keyMap[e.key.toUpperCase()])) pressedLanes.push(keyMap[e.key.toUpperCase()]);
  });
  window.addEventListener('keyup', e=>{
    const keyMap={'D':0,'F':1,'J':2,'K':3};
    const idx = pressedLanes.indexOf(keyMap[e.key.toUpperCase()]);
    if(idx>=0) pressedLanes.splice(idx,1);
  });
  canvas.addEventListener('touchstart', e=>{
    pressedLanes=[];
    for(const t of e.touches){
      const lane = Math.floor(t.clientX/laneWidth);
      if(!pressedLanes.includes(lane)) pressedLanes.push(lane);
    }
  });
  canvas.addEventListener('touchend', e=>{ pressedLanes=[]; });

  let startTime=Date.now();

  function getElapsed(){ return (Date.now()-startTime); }

  function judge(noteTime){
    const delta = Math.abs(getElapsed()-noteTime);
    for(const j of judgment){
      if(delta <= j.ms) return j.name;
    }
    return 'Over';
  }

  function draw(){
    ctx.fillStyle='#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // レーン描画
    for(let i=0;i<lanes;i++){
      ctx.strokeStyle='#555';
      ctx.lineWidth=2;
      ctx.strokeRect(i*laneWidth,100,laneWidth,canvas.height-200);
    }

    // ノーツ描画
    sla.notes.forEach(note=>{
      let x=note.lane*laneWidth;
      let y=150 + note.beat*100 - getElapsed()*0.5;
      let w = note.type==='all'?canvas.width:noteWidth;
      let h = 20;
      if(note.type!=='all') x += (laneWidth-w)/2;
      let color='#ccc';
      if(note.type==='all') color='#fff';
      if(note.type!=='all' && sla.notes.some(n=>n.type==='all' && Math.abs(n.beat-note.beat)<0.01)) color='#000';
      ctx.fillStyle=color;
      ctx.fillRect(x,y,w,h);
    });

    // スコア表示
    ctx.fillStyle='#fff';
    ctx.font='24px sans-serif';
    ctx.fillText('Score: '+score+' | Combo: '+combo, canvas.width-150,50);

    requestAnimationFrame(draw);
  }
  draw();
}
</script>
</body>
</html>
